<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Secure Notes Enterprise - Professional Edition</title>
    <script src="/static/vendor/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; background-color: #f0f2f5; color: #1c1e21; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1 { color: #050505; text-align: center; margin-bottom: 30px; font-weight: 700; }
        .auth-card { max-width: 400px; margin: 100px auto; text-align: center; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .toolbar button { background: #fff; color: #444; border: 1px solid #ccc; padding: 5px 12px; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .toolbar button:hover { background: #e9ecef; border-color: #bbb; }
        .note-editor { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; background: #fff; padding: 20px; border: 2px solid #007bff; border-radius: 10px; }
        #noteTitle { font-size: 1.1em; font-weight: 600; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        #noteContent { min-height: 150px; font-family: 'Consolas', 'Monaco', monospace; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; }
        .controls-row { display: flex; gap: 10px; align-items: center; }
        select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; }
        .btn-primary { background: #007bff; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: 600; flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary:hover { background: #0056b3; }
        .btn-cancel { background: #6c757d; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: 600; display: none; }
        .search-box { margin-bottom: 25px; position: relative; }
        #searchInput { width: 100%; padding: 12px 40px 12px 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .note { background: white; border: 1px solid #e1e4e8; padding: 20px; margin: 20px 0; border-radius: 10px; position: relative; transition: transform 0.2s; }
        .note:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .note h2 { margin-top: 0; color: #1a1a1a; font-size: 1.4em; border-bottom: 2px solid #007bff; display: inline-block; padding-bottom: 4px; }
        .note-body { margin: 15px 0; color: #24292e; overflow-x: auto; }
        .note-body pre { background: #f6f8fa; padding: 10px; border-radius: 6px; }
        .note-body input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; vertical-align: middle; }
        .note-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #586069; border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px; }
        .note-meta-items { display: flex; align-items: center; gap: 15px; }
        .meta-item { display: flex; align-items: center; gap: 4px; }
        .tag { background: #e7f3ff; color: #007bff; padding: 3px 10px; border-radius: 20px; font-weight: 600; }
        .action-btns { display: flex; gap: 5px; float: right; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .edit-btn { background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
        .swagger-link { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; color: #28a745; text-decoration: none; font-weight: 600; }
        #stats { text-align: center; margin-bottom: 15px; font-size: 0.9em; color: #666; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #loginSection { display: block; }
        #mainSection { display: none; }
        .icon { width: 16px; height: 16px; fill: currentColor; }
        table { width:100%; border-collapse: collapse; font-size: 0.85em; margin-top: 20px; }
        th { background:#f8f9fa; border-bottom:2px solid #ddd; padding:10px; text-align:left; }
        td { padding:8px; border-bottom:1px solid #eee; }
    </style>
</head>
<body>
    <div id="loginSection" class="container auth-card">
        <h1 id="authTitle">Secure Login</h1>
        <div class="input-group">
            <label>Benutzername</label>
            <input type="text" id="username" placeholder="admin" style="width:100%; padding:10px; box-sizing:border-box;">
        </div>
        <div class="input-group">
            <label>Passwort</label>
            <input type="password" id="password" placeholder="secret" style="width:100%; padding:10px; box-sizing:border-box;">
        </div>
        <button id="authBtn" class="btn-primary" style="width:100%" onclick="handleAuth()">Anmelden</button>
        <p style="margin-top: 15px; font-size: 0.9em;">
            <a href="#" id="authToggle" onclick="toggleAuthMode()">Noch kein Konto? Registrieren</a>
        </p>
        <p id="loginError" style="color: #dc3545; margin-top:15px; display: none; font-weight:600;">Zugriff verweigert!</p>
        <p id="registerSuccess" style="color: #28a745; margin-top:15px; display: none; font-weight:600;">Registrierung erfolgreich! Bitte anmelden.</p>
    </div>

    <div id="mainSection" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <a href="/docs" class="swagger-link">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14,2H6C4.89,2 4,2.89 4,4V20C4,21.11 4.89,22 6,22H18C19.11,22 20,21.11 20,20V8L14,2M12,18H6V16H12V18M18,14H6V12H18V14M18,10H6V8H18V10M13,9V3.5L18.5,9H13Z"/></svg>
                API Dokumentation (Swagger)
            </a>
            <div id="adminControls" style="display:none;">
                <button onclick="toggleAdminView()" class="edit-btn" id="adminViewBtn">Audit Logs anzeigen</button>
            </div>
            <button onclick="logout()" class="delete-btn">Abmelden</button>
        </div>
        
        <div id="notesView">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 id="editorTitle">Neue sichere Notiz</h1>
                <button onclick="exportData()" class="edit-btn">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M12,19L8,15H10.5V11H13.5V15H16L12,19Z"/></svg>
                    Exportieren (JSON)
                </button>
            </div>
            <div class="note-editor">
                <input type="hidden" id="editNoteId">
                <input type="text" id="noteTitle" placeholder="Ãœberschrift der Notiz...">
                <div class="toolbar">
                    <button onclick="insertMD('**', '**')">Fett</button>
                    <button onclick="insertMD('*', '*')">Kursiv</button>
                    <button onclick="insertMD('# ', '')">H1</button>
                    <button onclick="insertMD('- [ ] ', '')">Checkliste</button>
                    <button onclick="insertMD('```\n', '\n```')">Code</button>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <textarea id="noteContent" placeholder="Inhalt (Markdown unterstÃ¼tzt)..." oninput="updatePreview()"></textarea>
                    <div id="livePreview" style="padding:12px; border:1px solid #eee; border-radius:6px; background:#fafafa; overflow-y:auto; max-height:300px; font-size:0.9em; color:#444;">
                        <p style="color:#999; font-style:italic;">Live-Vorschau...</p>
                    </div>
                </div>

                <div class="controls-row">
                    <select id="tagInput">
                        <option value="Allgemein">Allgemein</option>
                        <option value="Wichtig">Wichtig</option>
                        <option value="Arbeit">Arbeit</option>
                        <option value="Privat">Privat</option>
                        <option value="Idee">Idee</option>
                    </select>
                    <button id="saveBtn" class="btn-primary" onclick="saveNote()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/></svg>
                        Sicher Speichern
                    </button>
                    <button id="cancelBtn" class="btn-cancel" onclick="cancelEdit()">Abbrechen</button>
                </div>
            </div>
            <hr style="border:0; border-top:1px solid #ddd; margin:30px 0;">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Suche in Titeln, Inhalten oder Tags..." onkeyup="fetchNotes()">
            </div>
            <div id="stats"></div>
            <div id="notesContainer"></div>
        </div>

        <div id="adminView" style="display:none;">
            <h1>Sicherheits-Audit-Logs</h1>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Zeitstempel</th>
                            <th>Benutzer</th>
                            <th>Aktion</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody id="logsContainer"></tbody>
                </table>
            </div>

            <h1 style="margin-top:40px;">Registrierte Benutzer</h1>
            <div id="userListContainer" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
        </div>
    </div>

    <script>
        let sessionToken = localStorage.getItem('sessionToken');
        let currentUser = localStorage.getItem('currentUser');
        let currentNotes = [];
        let isAdminView = false;
        let isLoginMode = true;

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('authTitle');
            const btn = document.getElementById('authBtn');
            const toggle = document.getElementById('authToggle');
            const error = document.getElementById('loginError');
            const success = document.getElementById('registerSuccess');
            error.style.display = 'none';
            success.style.display = 'none';
            if (isLoginMode) {
                title.innerText = "Secure Login";
                btn.innerText = "Anmelden";
                toggle.innerText = "Noch kein Konto? Registrieren";
            } else {
                title.innerText = "Registrieren";
                btn.innerText = "Konto erstellen";
                toggle.innerText = "Bereits ein Konto? Anmelden";
            }
        }

        async function handleAuth() {
            if (isLoginMode) await login(); else await register();
        }

        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (res.ok) {
                document.getElementById('registerSuccess').style.display = 'block';
                toggleAuthMode();
            } else {
                const data = await res.json();
                alert(data.detail || "Registrierung fehlgeschlagen");
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (res.ok) {
                const data = await res.json();
                sessionToken = data.token;
                currentUser = data.user;
                localStorage.setItem('sessionToken', sessionToken);
                localStorage.setItem('currentUser', currentUser);
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            fetch('/logout', { method: 'POST', headers: { 'X-Session-Token': sessionToken } });
            localStorage.removeItem('sessionToken');
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            if (currentUser === 'admin') document.getElementById('adminControls').style.display = 'block';
            fetchNotes();
        }

        async function toggleAdminView() {
            isAdminView = !isAdminView;
            const notesView = document.getElementById('notesView');
            const adminView = document.getElementById('adminView');
            const btn = document.getElementById('adminViewBtn');
            if (isAdminView) {
                notesView.style.display = 'none';
                adminView.style.display = 'block';
                btn.innerText = "ZurÃ¼ck zu Notizen";
                fetchLogs();
                fetchUsers();
            } else {
                notesView.style.display = 'block';
                adminView.style.display = 'none';
                btn.innerText = "Audit Logs anzeigen";
                fetchNotes();
            }
        }

        async function fetchUsers() {
            const res = await fetch('/admin/users', { headers: { 'X-Session-Token': sessionToken } });
            const users = await res.json();
            document.getElementById('userListContainer').innerHTML = users.map(u => `<span class="tag">ðŸ‘¤ ${u.username}</span>`).join('');
        }

        async function fetchLogs() {
            const res = await fetch('/admin/logs', { headers: { 'X-Session-Token': sessionToken } });
            if (res.status === 401) return logout();
            const logs = await res.json();
            document.getElementById('logsContainer').innerHTML = logs.map(l => `
                <tr>
                    <td>${l.timestamp}</td>
                    <td><strong>${l.user}</strong></td>
                    <td>${l.action}</td>
                    <td>${l.resource_id || '-'}</td>
                </tr>
            `).join('');
        }

        function updatePreview() {
            const content = document.getElementById('noteContent').value;
            document.getElementById('livePreview').innerHTML = content ? marked.parse(content) : '<p style="color:#999; font-style:italic;">Live-Vorschau...</p>';
        }

        async function exportData() {
            const res = await fetch('/export', { headers: { 'X-Session-Token': sessionToken } });
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes_export_${currentUser}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function insertMD(before, after) {
            const area = document.getElementById('noteContent');
            const start = area.selectionStart;
            const end = area.selectionEnd;
            area.value = area.value.substring(0, start) + before + area.value.substring(start, end) + after + area.value.substring(end);
            area.focus();
            updatePreview();
        }

        async function fetchNotes() {
            const q = document.getElementById('searchInput').value;
            const url = q ? `/notes?q=${encodeURIComponent(q)}` : '/notes';
            const res = await fetch(url, { headers: { 'X-Session-Token': sessionToken } });
            if (res.status === 401) return logout();
            currentNotes = await res.json();
            renderNotes();
            updateStats();
        }

        function renderNotes() {
            const container = document.getElementById('notesContainer');
            container.innerHTML = currentNotes.map((n, idx) => {
                let html = marked.parse(n.content);
                html = html.replace(/<li><input disabled="" type="checkbox">/g, `<li><input type="checkbox" onclick="toggleTask(${n.id}, ${idx}, event)">`);
                html = html.replace(/<li><input checked="" disabled="" type="checkbox">/g, `<li><input type="checkbox" checked onclick="toggleTask(${n.id}, ${idx}, event)">`);
                return `
                <div class="note">
                    <div class="action-btns">
                        <button onclick="editNote(${idx})" class="edit-btn">Bearbeiten</button>
                        <button onclick="deleteNote(${n.id})" class="delete-btn">LÃ¶schen</button>
                    </div>
                    <h2>${n.title}</h2>
                    <div class="note-body">${html}</div>
                    <div class="note-meta">
                        <span class="tag">${n.tags}</span>
                        <div class="note-meta-items">
                            <span class="meta-item">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/></svg>
                                ${n.created_at}
                            </span>
                            <span class="meta-item">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
                                ${n.user}
                            </span>
                        </div>
                    </div>
                </div>`;
            }).join('') || '<p style="text-align:center; color:#666;">Keine Notizen gefunden.</p>';
        }

        async function toggleTask(noteId, noteIdx, event) {
            const note = currentNotes[noteIdx];
            const isChecked = event.target.checked;
            const allCheckboxes = Array.from(event.target.closest('.note-body').querySelectorAll('input[type="checkbox"]'));
            const checkboxIndex = allCheckboxes.indexOf(event.target);
            const lines = note.content.split('\n');
            let count = 0;
            const newLines = lines.map(line => {
                if (line.match(/^(\s*[-*+]\s+\[)[ xX](\].*)$/)) {
                    if (count++ === checkboxIndex) return line.replace(/^(\s*[-*+]\s+\[)[ xX](\].*)$/, `$1${isChecked ? 'x' : ' '}$2`);
                }
                return line;
            });
            const newContent = newLines.join('\n');
            note.content = newContent;
            await fetch(`/notes/${noteId}`, {
                method: 'PUT',
                headers: { 'X-Session-Token': sessionToken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: note.title, content: newContent, tags: note.tags })
            });
            fetchNotes();
        }

        function editNote(idx) {
            const note = currentNotes[idx];
            document.getElementById('editNoteId').value = note.id;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('tagInput').value = note.tags;
            document.getElementById('editorTitle').innerText = "Notiz bearbeiten";
            document.getElementById('saveBtn').innerHTML = '<svg class="icon" viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/></svg> Ã„nderungen speichern';
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0, 0);
            updatePreview();
        }

        function cancelEdit() {
            document.getElementById('editNoteId').value = "";
            document.getElementById('noteTitle').value = "";
            document.getElementById('noteContent').value = "";
            document.getElementById('editorTitle').innerText = "Neue sichere Notiz";
            document.getElementById('saveBtn').innerHTML = '<svg class="icon" viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/></svg> Sicher Speichern';
            document.getElementById('cancelBtn').style.display = "none";
            updatePreview();
        }

        async function saveNote() {
            const id = document.getElementById('editNoteId').value;
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const tags = document.getElementById('tagInput').value;
            if (!title || !content) return alert("Bitte Titel und Inhalt ausfÃ¼llen!");
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/notes/${id}` : '/notes';
            await fetch(url, { 
                method: method, 
                headers: { 'X-Session-Token': sessionToken, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ title, content, tags }) 
            });
            cancelEdit();
            fetchNotes();
        }

        async function updateStats() {
            const res = await fetch('/stats', { headers: { 'X-Session-Token': sessionToken } });
            const stats = await res.json();
            document.getElementById('stats').innerHTML = `
                <svg class="icon" viewBox="0 0 24 24"><path d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/></svg>
                Tresor-Status: ${stats.total_notes} Notizen gesichert | Angemeldet als: ${stats.user}
            `;
        }

        async function deleteNote(id) {
            if (!confirm('Soll diese Notiz unwiderruflich aus dem Tresor gelÃ¶scht werden?')) return;
            await fetch(`/notes/${id}`, { method: 'DELETE', headers: { 'X-Session-Token': sessionToken } });
            fetchNotes();
        }

        if (sessionToken) showDashboard();
    </script>
</body>
</html>